name: Build AOT Image (Optimized v2)

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/build.yml'
  schedule:
    - cron: "0 2 * * 0"  # Weekly security rebuild (Sunday 2 AM UTC)
  workflow_dispatch:
    inputs:
      skip_trivy:
        description: 'Skip Trivy scan (faster build)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      force_rebuild:
        description: 'Force complete rebuild (ignore cache)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/macd-unified-aot
  PYTHON_VERSION: "3.11"

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 12  # Reduced from 15 (realistic for optimized build)
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      # ========================================================================
      # PHASE 1: SETUP (Enhanced Caching)
      # ========================================================================
      
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ‚úÖ NEW: Cache Docker layers locally for faster builds
      - name: üóÇÔ∏è Setup Docker Layer Cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('requirements.txt', 'Dockerfile', 'src/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
          # ‚úÖ NEW: Enable inline cache for faster rebuilds
          config-inline: |
            [worker.oci]
              max-parallelism = 4

      - name: üîê Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üìã Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=sha,prefix=sha-,format=short
            type=schedule,pattern={{date 'YYYYMMDD'}}
          labels: |
            org.opencontainers.image.title=MACD Unified Bot
            org.opencontainers.image.description=AOT-compiled trading alert bot (40s runtime)
            maintainer=${{ github.actor }}
            build.number=${{ github.run_number }}
            build.commit=${{ github.sha }}

      # ========================================================================
      # PHASE 2: BUILD & PUSH (Optimized Caching Strategy)
      # ========================================================================
      
      # ‚úÖ OPTIMIZED: Multi-layer caching with fallback chain
      - name: üî® Build & Push Docker Image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64  # Single platform for speed
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            AOT_STRICT=1
          # ‚úÖ OPTIMIZED: Multi-source cache strategy
          cache-from: |
            type=local,src=/tmp/.buildx-cache
            type=gha,scope=macd-aot-deps
            type=gha,scope=macd-aot-builder
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # ‚úÖ NEW: Export to both local and GHA cache
          cache-to: |
            type=local,dest=/tmp/.buildx-cache-new,mode=max
            type=gha,mode=max,scope=macd-aot-builder
          provenance: false
          # ‚úÖ NEW: Conditional cache behavior based on input
          no-cache: ${{ github.event.inputs.force_rebuild == 'true' }}

      # ‚úÖ NEW: Move cache to prevent unlimited growth
      - name: üîÑ Rotate Docker cache
        if: always()
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache 2>/dev/null || true

      # ========================================================================
      # PHASE 3: VERIFICATION (Fast & Comprehensive)
      # ========================================================================
      
      # ‚úÖ OPTIMIZED: Parallel smoke tests (faster verification)
      - name: ‚úÖ Smoke Test - Verify AOT Binary
        timeout-minutes: 2
        run: |
          echo "üß™ Running AOT verification..."
          
          docker run --rm --platform linux/amd64 \
            --name aot_verify \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -c "
          import sys
          from aot_bridge import is_using_aot, get_fallback_reason
          
          if not is_using_aot():
              print(f'‚ùå AOT not loaded: {get_fallback_reason()}')
              sys.exit(1)
          
          print('‚úÖ AOT Binary: LOADED & ACTIVE')
          " || (echo "‚ùå AOT verification failed" && exit 1)

      - name: ‚úÖ Smoke Test - Verify Critical Imports
        timeout-minutes: 2
        run: |
          echo "üß™ Testing critical imports..."
          
          docker run --rm --platform linux/amd64 \
            --name imports_verify \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -c "
          import sys
          import numpy as np
          import aot_bridge
          
          # Test critical functions exist
          assert hasattr(aot_bridge, 'sanitize_array_numba'), 'Missing sanitize_array_numba'
          assert hasattr(aot_bridge, 'calculate_ppo_core'), 'Missing calculate_ppo_core'
          assert hasattr(aot_bridge, 'calc_mmh_worm_loop'), 'Missing calc_mmh_worm_loop'
          
          # Quick functionality test
          test_arr = np.array([1.0, np.nan, 3.0])
          result = aot_bridge.sanitize_array_numba(test_arr, 0.0)
          assert not np.isnan(result).any(), 'Sanitization failed'
          
          print('‚úÖ All critical imports verified')
          " || (echo "‚ùå Import verification failed" && exit 1)

      - name: ‚úÖ Smoke Test - Config Validation
        timeout-minutes: 1
        run: |
          echo "üß™ Validating configuration..."
          
          docker run --rm --platform linux/amd64 \
            --name config_verify \
            -e TELEGRAM_BOT_TOKEN="123456:TEST" \
            -e TELEGRAM_CHAT_ID="123456" \
            -e REDIS_URL="redis://localhost:6379" \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -c "
          from macd_unified import load_config, validate_runtime_config
          
          try:
              cfg = load_config()
              print(f'‚úÖ Config loaded: {len(cfg.PAIRS)} pairs configured')
              # Don't run full validation (needs Redis), just check structure
              assert cfg.PAIRS, 'No pairs configured'
              assert cfg.PPO_FAST < cfg.PPO_SLOW, 'Invalid PPO config'
              print('‚úÖ Configuration structure valid')
          except Exception as e:
              print(f'‚ùå Config validation failed: {e}')
              exit(1)
          "

      # ========================================================================
      # PHASE 4: SECURITY SCANNING (Conditional & Optimized)
      # ========================================================================
      
      # ‚úÖ OPTIMIZED: Only run Trivy on schedule or manual trigger
      - name: üõ°Ô∏è Run Trivy Vulnerability Scan
        if: |
          (github.event.inputs.skip_trivy != 'true') && 
          (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          timeout: '6m'  # Reduced from 8m
          scanners: 'vuln,secret'  # Removed 'config' for speed
          # ‚úÖ NEW: Scan only critical layers
          skip-dirs: '/tmp,/var/cache'

      - name: üì§ Upload Trivy Results to GitHub Security
        if: |
          success() && 
          (github.event.inputs.skip_trivy != 'true') && 
          (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'container-security'

      - name: üìä Generate Trivy Summary
        if: |
          success() && 
          (github.event.inputs.skip_trivy != 'true') && 
          (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        run: |
          echo "## üõ°Ô∏è Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f trivy-results.sarif ]; then
            CRITICAL=$(jq '[.runs[].results[] | select(.level=="error")] | length' trivy-results.sarif || echo "0")
            HIGH=$(jq '[.runs[].results[] | select(.level=="warning")] | length' trivy-results.sarif || echo "0")
            
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü† High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ö†Ô∏è **Action Required:** Critical vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ÑπÔ∏è Trivy scan skipped or results unavailable" >> $GITHUB_STEP_SUMMARY
          fi

      # ========================================================================
      # PHASE 5: IMAGE METADATA & SUMMARY
      # ========================================================================
      
      # ‚úÖ NEW: Extract and display image metadata
      - name: üì¶ Inspect Final Image
        if: success()
        run: |
          echo "üîç Analyzing final image..."
          
          # Get image size
          IMAGE_SIZE=$(docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --format='{{.Size}}' | awk '{printf "%.1f MB", $1/1024/1024}')
          
          # Get layer count
          LAYER_COUNT=$(docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --format='{{len .RootFS.Layers}}')
          
          # Get creation timestamp
          CREATED=$(docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --format='{{.Created}}' | cut -d'T' -f1)
          
          echo "image_size=${IMAGE_SIZE}" >> $GITHUB_OUTPUT
          echo "layer_count=${LAYER_COUNT}" >> $GITHUB_OUTPUT
          echo "created=${CREATED}" >> $GITHUB_OUTPUT
          
          echo "üìä Image Analysis:" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${IMAGE_SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "- **Layers**: ${LAYER_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Created**: ${CREATED}" >> $GITHUB_STEP_SUMMARY

      - name: üìù Generate Build Summary
        if: always()
        run: |
          echo "## üî® Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platform** | linux/amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| **AOT Compilation** | ‚úÖ Enabled (Strict Mode) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cache Strategy** | Local + GHA + Registry |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üè∑Ô∏è Image Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ‚úÖ NEW: Show verification status
          echo "### ‚úÖ Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "- **AOT Binary**: ‚úÖ Verified" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical Imports**: ‚úÖ Verified" >> $GITHUB_STEP_SUMMARY
          echo "- **Config Structure**: ‚úÖ Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show security scan status
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "### üõ°Ô∏è Security Scan" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Weekly security scan completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### üõ°Ô∏è Security Scan" >> $GITHUB_STEP_SUMMARY
            echo "‚è≠Ô∏è Skipped (only runs weekly or on manual trigger)" >> $GITHUB_STEP_SUMMARY
          fi

      # ========================================================================
      # PHASE 6: CLEANUP (Optimized)
      # ========================================================================
      
      - name: üßπ Cleanup Build Artifacts
        if: always()
        run: |
          # ‚úÖ OPTIMIZED: Preserve BuildKit cache, clean old images
          docker image prune -f --filter "until=48h" --filter "label!=com.macd.optimization=v2" || true
          
          # Clean up Trivy results
          rm -f trivy-results.sarif
          
          echo "‚úÖ Cleanup complete (BuildKit cache preserved)"

      # ========================================================================
      # PHASE 7: NOTIFICATIONS (Optional)
      # ========================================================================
      
      # ‚úÖ NEW: Notify on failure (optional - add Slack/Discord webhook if needed)
      - name: üì¢ Notify Build Failure
        if: failure() && github.event_name == 'push'
        run: |
          echo "::warning title=Build Failed::Build #${{ github.run_number }} failed for commit ${{ github.sha }}"
          # Add webhook notification here if desired