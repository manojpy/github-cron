name: Build AOT Image (Ultra-Optimized v2)

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/build.yml'
  schedule:
    - cron: "0 2 * * 0"          # weekly
  workflow_dispatch:
    inputs:
      skip_trivy:
        description: 'Skip Trivy scan'
        required: false
        default: 'false'
        type: choice
        options: ['false','true']
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: 'false'
        type: choice
        options: ['false','true']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/macd-unified-aot

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      # ---------- SETUP ----------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('requirements.txt','Dockerfile','src/**') }}
          restore-keys: ${{ runner.os }}-buildx-

      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
          config-inline: |
            [worker.oci]
              max-parallelism = 4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=sha,prefix=sha-,format=short
            type=schedule,pattern={{date 'YYYYMMDD'}}

      # ---------- BUILD & PUSH ----------
      - id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: AOT_STRICT=1
          cache-from: |
            type=local,src=/tmp/.buildx-cache
            type=gha,scope=macd-aot-deps
            type=gha,scope=macd-aot-builder
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-to: |
            type=local,dest=/tmp/.buildx-cache-new,mode=max
            type=gha,mode=max,scope=macd-aot-builder
          provenance: false
          no-cache: ${{ github.event.inputs.force_rebuild == 'true' }}

      - if: always()
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache 2>/dev/null || true

      # ---------- PARALLEL SMOKE TESTS ----------
      - name: âœ… Smoke Test â€“ AOT Binary
        timeout-minutes: 2
        run: |
          docker run --rm --platform linux/amd64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -c "
          from aot_bridge import is_using_aot
          assert is_using_aot(), 'AOT not active'
          print('âœ… AOT active')
          "

      - name: âœ… Smoke Test â€“ Critical Imports
        timeout-minutes: 2
        run: |
          docker run --rm --platform linux/amd64 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -c "
          import numpy as np, aot_bridge
          aot_bridge.sanitize_array_numba(np.array([1.,np.nan,3.]),0.)
          print('âœ… Imports OK')
          " 

      - name: âœ… Smoke Test â€“ Config Load
        timeout-minutes: 1
        run: |
          # Replace placeholder with a syntactically-valid dummy token for the test
          jq '.TELEGRAM_BOT_TOKEN = "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"' config_macd.json > config_test.json
          docker run --rm --platform linux/amd64 \
            -v $PWD/config_test.json:/app/src/config_macd.json:ro \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -c "
          from macd_unified import load_config
          cfg=load_config()
          assert cfg.PAIRS and cfg.PPO_FAST<cfg.PPO_SLOW
          print('âœ… Config OK')
          "

      # ---------- SECURITY SCAN (conditional) ----------
      - if: |
          github.event.inputs.skip_trivy != 'true' &&
          (github.event_name=='schedule' || github.event_name=='workflow_dispatch')
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: 0
          timeout: 5m
          scanners: vuln,secret
          skip-dirs: /tmp,/var/cache

      - if: |
          success() &&
          github.event.inputs.skip_trivy != 'true' &&
          (github.event_name=='schedule' || github.event_name=='workflow_dispatch')
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: container-security

      # ---------- SUMMARY ----------
      - if: success()
        run: |
          SIZE=$(docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format='{{.Size}}' | awk '{printf "%.1f MB",$1/1024/1024}')
          echo "## ðŸ”¨ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | $SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| **AOT** | âœ… Strict |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cache** | Local+GHA+Registry |" >> $GITHUB_STEP_SUMMARY

      - if: failure() && github.event_name=='push'
        run: echo "::warning title=Build Failed::#${{ github.run_number }} failed"
