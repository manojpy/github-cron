name: Run MACD Bot

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  RUN_TIMEOUT: 600

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: âœ… Prepare logs
      run: mkdir -p logs && sudo chown -R 1000:1000 logs

    - name: ðŸ›¡ï¸ Inject Secrets into config_macd.json
      # This looks for config_macd.json in the ROOT of your repo
      env:
        TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        REDIS: ${{ secrets.REDIS_URL }}
        API_BASE: ${{ secrets.DELTA_API_BASE }}
      run: |
        if [ ! -f "config_macd.json" ]; then echo "âŒ Error: config_macd.json not found in root!"; exit 1; fi
        
        jq --arg token "$TOKEN" --arg chat "$CHAT_ID" --arg redis "$REDIS" --arg api "$API_BASE" \
        '.TELEGRAM_BOT_TOKEN=$token | .TELEGRAM_CHAT_ID=$chat | .REDIS_URL=$redis | .DELTA_API_BASE=$api' \
        config_macd.json > config_macd.secure.json
        
        echo "âœ… Secure config created."

    - name: Log in to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ”¥ Launch Bot
      run: |
        IMAGE_ID=$(echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/macd-unified-aot:latest" | tr '[:upper:]' '[:lower:]')
        
        # We mount the SECURE version of the config directly over the template in the container
        timeout ${{ env.RUN_TIMEOUT }}s docker run --rm --init \
          --name macd-bot-instance \
          --memory=1g \
          --cpus=2.0 \
          -v ${{ github.workspace }}/config_macd.secure.json:/app/src/config_macd.json:ro \
          -v ${{ github.workspace }}/logs:/app/logs \
          "$IMAGE_ID"