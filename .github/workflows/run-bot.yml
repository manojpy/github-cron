name: ðŸ¤– Run MACD Unified Bot

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (log alerts only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_alerts:
        description: 'Skip Telegram alerts (test mode)'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: manojpy/github-cron/macd-unified-aot
  BOT_TIMEOUT: 300  # 5 minutes (sufficient for 30-40s job)

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 8
    permissions:
      contents: read
      packages: read

    steps:
      # ========================================================================
      # PHASE 1: SETUP
      # ========================================================================
      
      - name: ðŸ“¥ Checkout Config Only
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            config_macd.json
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ðŸ” Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ³ Pull Latest AOT Image
        id: image_pull
        run: |
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "ðŸ“¦ Pulling AOT image..."
          START_TIME=$(date +%s)
          
          # Quiet pull to reduce log overhead
          if docker pull --quiet --platform linux/amd64 "$IMAGE_REF"; then
            PULL_TIME=$(( $(date +%s) - START_TIME ))
            echo "âœ… Image pulled in ${PULL_TIME}s"
            echo "pull_time=${PULL_TIME}" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to pull image"
            exit 1
          fi
          echo "image_ref=${IMAGE_REF}" >> $GITHUB_OUTPUT

      # ========================================================================
      # PHASE 2: BOT EXECUTION (Optimized)
      # ========================================================================
      
      - name: ðŸš€ Execute MACD Bot
        id: bot_run
        timeout-minutes: 6
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          # --- Fast Secret Verification (Merged Step) ---
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.REDIS_URL }}" ]; then
             echo "âŒ Missing Secrets"; exit 1
          fi

          mkdir -p logs
          
          echo "::group::ðŸ”¥ Starting Bot Execution"
          echo "ðŸ“… Trigger: $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S IST')"
          echo "ðŸ§ª Dry Run: $DRY_RUN"
          echo "::endgroup::"
          
          START_TIME=$(date +%s)
          
          # âœ… OPTIMIZED: --network host (skip bridge overhead), --read-only, tmpfs tuning
          # Removed redundant 'timeout' command wrapper (managed by internal logic)
          docker run \
            --rm \
            --name macd_bot_runner \
            --platform linux/amd64 \
            --network host \
            --memory="900m" \
            --memory-swap="900m" \
            --cpus="2.0" \
            --security-opt=no-new-privileges \
            --read-only \
            --tmpfs /tmp:rw,size=64m,mode=1777 \
            --tmpfs /home/appuser/.cache:rw,size=32m,mode=1777 \
            -e TZ=Asia/Kolkata \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DRY_RUN_MODE="$DRY_RUN" \
            -e PYTHONUNBUFFERED=1 \
            -e NUMBA_NUM_THREADS=2 \
            -e OMP_NUM_THREADS=2 \
            -v "${{ github.workspace }}/config_macd.json:/app/src/config_macd.json:ro" \
            ${{ steps.image_pull.outputs.image_ref }} 2>&1 | tee logs/bot_output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          DURATION=$(( $(date +%s) - START_TIME ))
          
          echo "execution_time=${DURATION}" >> $GITHUB_OUTPUT
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Bot exited with code $EXIT_CODE"
            exit 1
          fi
          echo "âœ… Bot completed in ${DURATION}s"

      # ========================================================================
      # PHASE 3: RESULTS ANALYSIS
      # ========================================================================
      
      - name: ðŸ“Š Parse Results
        if: always()
        id: results
        run: |
          LOG_FILE="logs/bot_output.log"
          if [ ! -f "$LOG_FILE" ]; then
            echo "status=error" >> $GITHUB_OUTPUT; echo "message=Log missing" >> $GITHUB_OUTPUT; exit 0
          fi
          
          # Single-pass parsing for speed
          if grep -q "âœ… RUN COMPLETE" "$LOG_FILE"; then
            echo "status=success" >> $GITHUB_OUTPUT
            # Extract metrics using efficient greps
            echo "duration=$(grep -oP "Duration:\s*\K[\d.]+" "$LOG_FILE" | head -1)" >> $GITHUB_OUTPUT
            echo "alerts=$(grep -oP "Alerts:\s*\K\d+" "$LOG_FILE" | head -1)" >> $GITHUB_OUTPUT
            echo "pairs=$(grep -oP "Pairs:\s*\K[\d/]+" "$LOG_FILE" | head -1)" >> $GITHUB_OUTPUT
            echo "memory=$(grep -oP "Memory:\s*\K\d+MB" "$LOG_FILE" | head -1)" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error_msg=$(grep -E "FATAL ERROR|Bot run failed" "$LOG_FILE" | head -1 | cut -c1-100)" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“ Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– Bot Report
          | Status | Time | Duration | Alerts | Pairs | Mem |
          |---|---|---|---|---|---|
          | ${{ steps.results.outputs.status == 'success' && 'âœ…' || 'âŒ' }} | $(TZ=Asia/Kolkata date '+%H:%M') | ${{ steps.results.outputs.duration }}s | ${{ steps.results.outputs.alerts }} | ${{ steps.results.outputs.pairs }} | ${{ steps.results.outputs.memory }} |
          EOF

      - name: ðŸ“¦ Logs (On Failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: logs/
          retention-days: 1

      - name: ðŸ§¹ Cleanup
        if: always()
        run: docker rm -f macd_bot_runner 2>/dev/null || true