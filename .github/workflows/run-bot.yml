name: ðŸ¤– Run MACD Unified Bot (Manual)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (log alerts only)'
        required: false
        default: 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: manojpy/github-cron/macd-unified-aot

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ” Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ³ Pull & Verify AOT Image
      id: image-pull
      run: |
        BOT_IMAGE="ghcr.io/${{ env.IMAGE_NAME }}:latest"
        echo "ðŸš€ Pulling latest AOT image..."
        docker pull --quiet $BOT_IMAGE
        
        # Verify AOT
        docker run --rm --entrypoint python $BOT_IMAGE \
          -c "import aot_bridge; aot_bridge.ensure_initialized(); print('âœ… AOT OK:', aot_bridge.is_using_aot())"
        
        echo "BOT_IMAGE=$BOT_IMAGE" >> $GITHUB_ENV

    - name: ðŸš€ Setup and Execute Bot
      id: bot_run
      env:
        DRY_RUN_MODE: ${{ github.event.inputs.dry_run == 'true' && 'true' || 'false' }}
      run: |
        set +x
        echo "ðŸ”¥ Launching Macd Unified ðŸ”¥ðŸš€"
        echo "::group::ðŸ”„ Pulling Latest AOT Image"
        docker pull --quiet $BOT_IMAGE
        echo "::endgroup::"
        
        # Create logs dir (matches original)
        mkdir -p logs
        
        # EXACTLY matches your ORIGINAL docker run [file:7]
        docker run --rm \
          --name macd_bot_container \
          -e TZ=Asia/Kolkata \
          -e TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
          -e TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
          -e REDIS_URL=${{ secrets.REDIS_URL }} \
          -v ${{ github.workspace }}/config_macd.json:/app/src/config_macd.json \
          $BOT_IMAGE | tee bot_output.log
        
        echo "::endgroup::"

    - name: ðŸ“Š Generate Job Summary
      if: always()
      run: |
        echo "### ðŸš€ MACD Bot Run Results (IST)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if grep -q "âœ… RUN COMPLETE" bot_output.log; then
          # Parse EXACTLY like original
          DURATION=$(grep "Duration:" bot_output.log | awk -F'Duration: ' '{print $2}' | awk '{print $1}')
          ALERTS=$(grep "Alerts:" bot_output.log | awk -F'Alerts: ' '{print $2}' | awk '{print $1}')
          PAIRS=$(grep "Pairs:" bot_output.log | awk -F'Pairs: ' '{print $2}' | awk '{print $1}')
          
          echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timezone** | ðŸ‡®ðŸ‡³ IST (Asia/Kolkata) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Execution** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| **Pairs Processed** | $PAIRS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Duration** | $DURATION |" >> $GITHUB_STEP_SUMMARY
          echo "| **Alerts Sent** | $ALERTS |" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Run Failed or Timed Out**" >> $GITHUB_STEP_SUMMARY
          echo "Please check the 'Setup and Execute Bot' logs for details." >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker rm -f macd_bot_container || true
        rm -f bot_output.log
        docker image prune -f || true
        echo "âœ… Cleanup complete"