name: ðŸ¤– Run MACD Unified Bot (Ultra v2)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode'
        required: false
        default: 'false'
        type: choice
        options: ['false','true']
      skip_alerts:
        description: 'Skip Telegram alerts'
        required: false
        default: false
        type: boolean
      debug_mode:
        description: 'Debug logging'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: manojpy/github-cron/macd-unified-aot
  BOT_TIMEOUT: 300

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 6
    permissions:
      contents: read
      packages: read

    steps:
      # ---------- SETUP ----------
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            config_macd.json
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: image_pull
        run: |
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          START=$(date +%s)
          if docker image inspect "$IMAGE_REF" &>/dev/null; then
            CACHED=true
          else
            CACHED=false
            docker pull --quiet --platform linux/amd64 "$IMAGE_REF"
          fi
          END=$(date +%s)
          echo "pull_time=$((END-START))" >> $GITHUB_OUTPUT
          echo "cached=${CACHED}" >> $GITHUB_OUTPUT
          echo "image_ref=${IMAGE_REF}" >> $GITHUB_OUTPUT

      # parallel pre-warm + secrets
      - name: ðŸ”’ Verify Secrets
        run: |
          for s in TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID REDIS_URL; do
            [ -z "${{ secrets[env.s] }}" ] && { echo "::error::Missing $s"; exit 1; }
          done
          echo "âœ… Secrets OK"

      - name: ðŸ”¥ Pre-warm
        id: prewarm
        timeout-minutes: 1
        run: |
          START=$(date +%s)
          docker run --rm --platform linux/amd64 \
            ${{ steps.image_pull.outputs.image_ref }} \
            python -c "import aot_bridge,numpy; print('warmed')" &>/dev/null || true
          echo "prewarm_time=$(($(date +%s)-START))" >> $GITHUB_OUTPUT

      # ---------- BOT RUN ----------
      - name: ðŸš€ Execute Bot
        id: bot_run
        timeout-minutes: 5
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        run: |
          mkdir -p logs
          START=$(date +%s)
          set -o pipefail
          timeout --signal=SIGTERM --kill-after=15s ${{ env.BOT_TIMEOUT }}s \
          docker run --rm --name macd_bot_runner --platform linux/amd64 \
            --memory=900m --memory-swap=900m --cpus=2 --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=80m \
            --tmpfs /home/appuser/.cache:rw,noexec,nosuid,size=20m \
            -e TZ=Asia/Kolkata \
            -e TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
            -e TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
            -e REDIS_URL=${{ secrets.REDIS_URL }} \
            -e DRY_RUN_MODE=$DRY_RUN \
            -e DEBUG_MODE=$DEBUG_MODE \
            -e NUMBA_NUM_THREADS=2 \
            -e OMP_NUM_THREADS=2 \
            -e TRIGGER_TIMESTAMP=$(date +%s) \
            -v $PWD/config_macd.json:/app/src/config_macd.json:ro \
            ${{ steps.image_pull.outputs.image_ref }} 2>&1 | tee logs/bot_output.log
          EXIT=${PIPESTATUS[0]}
          END=$(date +%s)
          echo "execution_time=$((END-START))" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT" >> $GITHUB_OUTPUT
          if [ $EXIT -ne 0 ]; then
            [ $EXIT -eq 124 ] && echo "::error::Timeout"
            [ $EXIT -eq 137 ] && echo "::error::Killed"
            exit 1
          fi

      # ---------- PARSE ----------
      - id: results
        if: always()
        run: |
          awk '
          /âœ… RUN COMPLETE/{st="success"}
          /Duration: ([0-9.]+)s/ && st=="success"{dur=$2}
          /Alerts: ([0-9]+)/ && st=="success"{alt=$2}
          /Pairs: ([0-9/]+)/ && st=="success"{pairs=$2}
          /Memory: ([0-9]+MB)/ && st=="success"{mem=$2}
          /Redis: ([A-Z]+)/ && st=="success"{redis=$2}
          /FATAL ERROR/{st="failed"; getline; msg=substr($0,1,100)}
          END{
            if(!st) st="timeout"; if(!dur) dur="N/A"; if(!alt) alt="0"
            if(!pairs) pairs="N/A"; if(!mem) mem="N/A"; if(!redis) redis="UNKNOWN"; if(!msg) msg="None"
            print "status="st; print "duration="dur; print "alerts="alt; print "pairs="pairs
            print "memory="mem; print "redis_status="redis; print "error_msg="msg
          }
          ' logs/bot_output.log >> $GITHUB_OUTPUT || true

      - id: alert_details
        if: success() && steps.results.outputs.status=='success'
        run: |
          LOG=logs/bot_output.log
          echo "ppo_alerts=$(grep -c 'PPO cross'   "$LOG" 2>/dev/null||0)" >> $GITHUB_OUTPUT
          echo "rsi_alerts=$(grep -c 'RSI cross'   "$LOG" 2>/dev/null||0)" >> $GITHUB_OUTPUT
          echo "vwap_alerts=$(grep -c 'VWAP'       "$LOG" 2>/dev/null||0)" >> $GITHUB_OUTPUT
          echo "mmh_alerts=$(grep -c 'MMH Reversal' "$LOG" 2>/dev/null||0)" >> $GITHUB_OUTPUT
          echo "pivot_alerts=$(grep -c 'Cross above\|Cross below' "$LOG" 2>/dev/null||0)" >> $GITHUB_OUTPUT

      # ---------- SUMMARY ----------
      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ¤– MACD Bot Execution Report
          | Metric | Value |
          |--------|-------|
          | **Status** | ${{ steps.results.outputs.status=='success' && 'âœ… Success' || steps.results.outputs.status=='failed' && 'âŒ Failed' || 'â±ï¸ Timeout' }} |
          | **Duration** | ${{ steps.results.outputs.duration }}s |
          | **Pairs** | ${{ steps.results.outputs.pairs }} |
          | **Alerts** | ${{ steps.results.outputs.alerts }} |
          | **Memory** | ${{ steps.results.outputs.memory }} |
          | **Redis** | ${{ steps.results.outputs.redis_status }} |
          | **Dry Run** | ${{ github.event.inputs.dry_run }} |
          | **Debug** | ${{ github.event.inputs.debug_mode }} |
          | **Image Cache** | ${{ steps.image_pull.outputs.cached=='true' && 'âœ… Hit' || 'âŒ Miss' }} |
          EOF

          if [ "${{ steps.results.outputs.status }}" == "success" ]; then
            echo "| Alert Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| PPO        | ${{ steps.alert_details.outputs.ppo_alerts }} |" >> $GITHUB_STEP_SUMMARY
            echo "| RSI        | ${{ steps.alert_details.outputs.rsi_alerts }} |" >> $GITHUB_STEP_SUMMARY
            echo "| VWAP       | ${{ steps.alert_details.outputs.vwap_alerts }} |" >> $GITHUB_STEP_SUMMARY
            echo "| MMH        | ${{ steps.alert_details.outputs.mmh_alerts }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Pivot      | ${{ steps.alert_details.outputs.pivot_alerts }} |" >> $GITHUB_STEP_SUMMARY
          fi

      # ---------- ARTIFACTS ----------
      - if: failure() || github.event.inputs.debug_mode=='true'
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: logs/
          retention-days: 3
          compression-level: 9

      - if: success() && steps.results.outputs.status=='success'
        run: |
          mkdir -p metrics
          cat > metrics/execution_metrics.json <<EOF
          {
            "timestamp":"$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "run_number":${{ github.run_number }},
            "duration_seconds":${{ steps.bot_run.outputs.execution_time }},
            "pairs_processed":"${{ steps.results.outputs.pairs }}",
            "alerts_sent":${{ steps.results.outputs.alerts }},
            "memory_mb":"${{ steps.results.outputs.memory }}",
            "redis_status":"${{ steps.results.outputs.redis_status }}",
            "alert_breakdown":{
              "ppo":${{ steps.alert_details.outputs.ppo_alerts }},
              "rsi":${{ steps.alert_details.outputs.rsi_alerts }},
              "vwap":${{ steps.alert_details.outputs.vwap_alerts }},
              "mmh":${{ steps.alert_details.outputs.mmh_alerts }},
              "pivot":${{ steps.alert_details.outputs.pivot_alerts }}
            }
          }
          EOF

      # ---------- CLEANUP ----------
      - if: always()
        run: |
          docker stop macd_bot_runner 2>/dev/null || true
          docker rm -f macd_bot_runner 2>/dev/null || true
          echo "âœ… Cleanup (image preserved)"
