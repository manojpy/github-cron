name: Run Unified MACD Bot (Optimized)

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [cron_trigger]

concurrency:
  group: trading-bot-execution
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      packages: read
      deployments: write

    steps:
      - name: Log execution context
        run: |
          echo "ğŸš€ Triggered via: ${{ github.event_name }}"
          echo "â° UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "â° IST Time: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”‹ Run ID: ${{ github.run_id }}"

      # OPTIMIZATION 1: Use sparse checkout (already optimized)
      - name: Checkout config
        uses: actions/checkout@v4
        with:
          sparse-checkout: config_macd.json
          sparse-checkout-cone-mode: false

      # OPTIMIZATION 2: Cache Docker layers
      - name: Set up Docker layer cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            docker-${{ runner.os }}-

      # OPTIMIZATION 3: Use Docker Buildx with cache
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # OPTIMIZATION 4: Pull with aggressive caching
      - name: Pull latest image (with cache)
        id: pull_image
        run: |
          IMAGE="ghcr.io/${{ github.repository }}/trading-bot:latest"
          
          # Check if image exists in cache
          if docker images -q "$IMAGE" 2>/dev/null | grep -q .; then
            echo "âœ… Using cached image"
          else
            echo "Pulling $IMAGE..."
            docker pull "$IMAGE"
          fi
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Set trigger timestamp
        id: timestamp
        run: |
          TS=$(date +%s)
          echo "ts=$TS" >> $GITHUB_OUTPUT

      # OPTIMIZATION 5: Skip JSON validation (already validated in build)
      - name: Validate configuration
        run: |
          [ -f config_macd.json ] || { echo "âŒ config missing"; exit 1; }
          echo "âœ… Config exists"

      # OPTIMIZATION 6: Streamlined container run
      - name: Run trading bot
        id: run_bot
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: |
          docker run --rm \
            --name bot-${{ github.run_id }} \
            --memory="512m" \
            --cpus="1.0" \
            --read-only \
            --tmpfs /tmp:rw,size=100m \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DELTA_API_BASE="${{ secrets.DELTA_API_BASE }}" \
            -e CONFIG_FILE=config_macd.json \
            -e TZ=Asia/Kolkata \
            -e LOG_JSON=false \
            -e FILE_LOGGING=false \
            -e DEBUG_MODE="$DEBUG_MODE" \
            -e TRIGGER_TIMESTAMP="${{ steps.timestamp.outputs.ts }}" \
            -e GITHUB_RUN_ID="${{ github.run_id }}" \
            -v "$(pwd)/config_macd.json:/app/config_macd.json:ro" \
            ghcr.io/${{ github.repository }}/trading-bot:latest
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          [ $EXIT_CODE -eq 0 ] && echo "âœ… Success" || exit $EXIT_CODE

      - name: Log execution summary
        if: always()
        run: |
          echo "ğŸ“Š Status: ${{ job.status }}"
          echo "   Exit: ${{ steps.run_bot.outputs.exit_code || 'N/A' }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Failed at $(date -u)"
          echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # OPTIMIZATION 7: Skip cleanup (GitHub does this automatically)