name: Run MACD Bot

on:
  workflow_dispatch:      

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup and Execute Bot
        id: bot_run
        run: |
          # 1. Hide the noisy pulling process inside a collapsed group
          echo "::group::ðŸ”„ Pulling Latest AOT Image"
          docker pull --quiet ghcr.io/manojpy/github-cron/macd-unified-aot:latest
          echo "::endgroup::"

          # 2. Run the bot
          # We capture the output to a file so we can generate a summary later
          docker run --rm \
            --name macd_bot_container \
            -e TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
            -e TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
            -v ${{ github.workspace }}/config_macd.json:/app/src/config_macd.json \
            ghcr.io/manojpy/github-cron/macd-unified-aot:latest | tee bot_output.log

      - name: Generate Job Summary
        if: always()
        run: |
          echo "### ðŸš€ MACD Bot Run Results" >> $GITHUB_STEP_SUMMARY
          if grep -q "âœ… RUN COMPLETE" bot_output.log; then
            DURATION=$(grep "Duration:" bot_output.log | awk -F'Duration: ' '{print $2}' | awk '{print $1}')
            ALERTS=$(grep "Alerts:" bot_output.log | awk -F'Alerts: ' '{print $2}' | awk '{print $1}')
            echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| **AOT Status** | âœ… Active |" >> $GITHUB_STEP_SUMMARY
            echo "| **Execution** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            echo "| **Duration** | $DURATION |" >> $GITHUB_STEP_SUMMARY
            echo "| **Alerts Sent** | $ALERTS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Run Failed or Timed Out**" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi