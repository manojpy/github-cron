name: Run Trading Bot

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [cron_trigger]

# Prevent concurrent runs (Redis lock safety)
concurrency:
  group: trading-bot-execution
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    permissions:
      packages: read
      contents: read

    steps:
      - name: Log execution context
        run: |
          echo "ğŸš€ Bot Execution Started"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Trigger:    ${{ github.event_name }}"
          echo "  Run ID:     ${{ github.run_id }}"
          echo "  Run #:      ${{ github.run_number }}"
          echo "  UTC Time:   $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "  IST Time:   $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"
          echo "  Timestamp:  $(date +%s)"
          echo "  Debug Mode: ${{ github.event.inputs.debug_mode || 'false' }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Only checkout config file (faster than full repo)
      - name: Checkout config
        uses: actions/checkout@v4
        with:
          sparse-checkout: config_macd.json
          sparse-checkout-cone-mode: false

      - name: Validate configuration
        run: |
          if [ ! -f config_macd.json ]; then
            echo "âŒ config_macd.json not found"
            exit 1
          fi
          
          # Validate JSON syntax
          if command -v jq >/dev/null 2>&1; then
            if jq empty config_macd.json 2>/dev/null; then
              echo "âœ… Configuration file valid"
            else
              echo "âŒ Invalid JSON syntax in config_macd.json"
              exit 1
            fi
          else
            echo "âœ… Configuration file exists (jq not available for validation)"
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest Docker image
        id: pull_image
        run: |
          IMAGE="ghcr.io/${{ github.repository }}/trading-bot:latest"
          echo "ğŸ“¥ Pulling $IMAGE..."
          
          if docker pull "$IMAGE"; then
            echo "âœ… Image pulled successfully"
            echo ""
            echo "ğŸ“¦ Image Info:"
            docker inspect "$IMAGE" --format='  ID: {{.Id}}'
            docker inspect "$IMAGE" --format='  Created: {{.Created}}'
            docker inspect "$IMAGE" --format='  Size: {{.Size}}' | \
              awk '{printf "  Size: %.2f MB\n", $1/1024/1024}'
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to pull image"
            echo ""
            echo "ğŸ’¡ Troubleshooting steps:"
            echo "   1. Check if 'Build & Push Docker Image' workflow has run successfully"
            echo "   2. Verify GHCR permissions in Settings â†’ Actions â†’ General"
            echo "   3. Check image exists: https://github.com/${{ github.repository }}/pkgs/container/trading-bot"
            echo ""
            exit 1
          fi

      - name: Set trigger timestamp
        id: timestamp
        run: |
          TS=$(date +%s)
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "ğŸ“… Trigger timestamp: $TS ($(date -d @$TS -u '+%Y-%m-%d %H:%M:%S UTC'))"

      - name: Run trading bot
        id: run_bot
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: |
          set +x  # Don't echo secrets
          echo "ğŸ¤– Starting bot execution..."
          echo ""
          
          # Run with optimized resource limits
          docker run --rm \
            --name trading-bot-${{ github.run_id }} \
            --memory="512m" \
            --memory-swap="512m" \
            --cpus="1.0" \
            --security-opt no-new-privileges \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=100m \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DELTA_API_BASE="${{ secrets.DELTA_API_BASE }}" \
            -e CONFIG_FILE=config_macd.json \
            -e TZ=Asia/Kolkata \
            -e DEBUG_MODE="$DEBUG_MODE" \
            -e TRIGGER_TIMESTAMP="${{ steps.timestamp.outputs.ts }}" \
            -e GITHUB_SHA="${{ github.sha }}" \
            -e GITHUB_RUN_ID="${{ github.run_id }}" \
            -e GITHUB_RUN_NUMBER="${{ github.run_number }}" \
            -v "$(pwd)/config_macd.json:/app/config_macd.json:ro" \
            ghcr.io/${{ github.repository }}/trading-bot:latest
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          echo ""
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Bot execution completed successfully"
          else
            echo "âŒ Bot execution failed with exit code: $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Execution summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š Execution Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Status:     ${{ job.status }}"
          echo "  Exit Code:  ${{ steps.run_bot.outputs.exit_code || 'N/A' }}"
          echo "  Run ID:     ${{ github.run_id }}"
          echo "  Completed:  $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  Logs:       https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Bot execution failed"
          echo "ğŸ”— Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“‹ Run Number: ${{ github.run_number }}"
          echo "â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Optional: Send webhook notification
          # curl -X POST "https://your-webhook.com/notify" \
          #   -H "Content-Type: application/json" \
          #   -d '{"status":"failed","run_id":"${{ github.run_id }}"}'

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up Docker resources..."
          docker system prune -f --volumes || true
          echo "âœ… Cleanup complete"