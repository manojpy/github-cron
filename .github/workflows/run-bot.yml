name: Run Unified MACD Bot

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [cron_trigger]

concurrency:
  group: trading-bot-execution
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    
    permissions:
      contents: read

    steps:
      - name: Log execution context
        run: |
          echo "üöÄ Run #${{ github.run_number }} at $(TZ='Asia/Kolkata' date '+%H:%M:%S IST')"

      # OPTIMIZATION: Full checkout (need all source files)
      - name: Checkout repository
        uses: actions/checkout@v4

      # OPTIMIZATION: Cache Python dependencies (huge time saver!)
      - name: Cache Python dependencies
        uses: actions/cache@v4
        id: cache_python
        with:
          # Caching standard pip cache location, which uv also respects
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # OPTIMIZATION: Use Python 3.11 with uv for super-fast installs
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # OPTIMIZATION: Install uv and dependencies in a single step (reduces shell startup overhead)
      - name: Install uv and dependencies
        run: |
          # 1. Install uv
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env
          
          # 2. Install dependencies using uv (fast!)
          # Fix pycares/aiodns compatibility first (if needed by your environment)
          uv pip install --system pycares==4.4.0 aiodns==3.2.0
          
          # Install all other dependencies
          uv pip install --system -r requirements.txt
          
          echo "‚úÖ Dependencies installed"

      # OPTIMIZATION: Use a shell step to get the current timestamp in India/Kolkata
      - name: Get current timestamp
        id: timestamp
        run: |
          # Get current epoch timestamp in seconds (as integer)
          TS=$(TZ='Asia/Kolkata' date +%s)
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "Current TS: $TS"

      - name: Run unified MACD bot
        id: run_bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          DELTA_API_BASE: ${{ secrets.DELTA_API_BASE }}
          CONFIG_FILE: config_macd.json
          TZ: Asia/Kolkata
          LOG_JSON: false
          FILE_LOGGING: false
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          TRIGGER_TIMESTAMP: ${{ steps.timestamp.outputs.ts }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          PYTHONUNBUFFERED: 1
          # PYTHONOPTIMIZE=2 disables docstrings and asserts (minor speed boost)
          PYTHONOPTIMIZE: 2

        run: |
          set +x
          echo "ü§ñ Starting bot execution..."
          
          # Execute the optimized Python wrapper
          python -u wrapper.py
          
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Bot execution completed successfully"
          else
            echo "‚ùå Bot execution failed with exit code: $EXIT_CODE"
            # Exit with the same code to mark the job as failed
            exit $EXIT_CODE
          fi

      - name: Log execution summary
        if: always()
        run: |
          echo "üìä Summary:"
          echo "  Status: ${{ job.status }}"
          echo "  Exit: ${{ steps.run_bot.outputs.exit_code || 'N/A' }}"
          echo "  Cache: ${{ steps.cache_python.outputs.cache-hit || 'miss' }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Job failed. Check details in GitHub Actions."
          # Add your notification logic here if needed (e.g., send a failure message via curl/bot)