name: Run Unified MACD Bot

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [cron_trigger]

concurrency:
  group: trading-bot-execution
  cancel-in-progress: false

env:
  IMAGE: ghcr.io/${{ github.repository }}/trading-bot:latest

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      packages: read

    steps:
      - name: Log execution context
        run: |
          echo "üöÄ Triggered via: ${{ github.event_name }}"
          echo "‚è∞ UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "üîß Debug Mode: ${{ github.event.inputs.debug_mode || 'false' }}"
          echo "üìã Run ID: ${{ github.run_id }}"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        run: |
          docker pull "$IMAGE"
          docker inspect "$IMAGE" --format='Image ID: {{.Id}}'

      - name: Set trigger timestamp
        id: timestamp
        run: echo "ts=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Run trading bot
        id: run_bot
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: |
          docker run --rm \
            --name trading-bot-${{ github.run_id }} \
            --memory="512m" --memory-swap="512m" --cpus="1.0" \
            --security-opt no-new-privileges --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=100m \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DELTA_API_BASE="${{ secrets.DELTA_API_BASE }}" \
            -e CONFIG_FILE=config_macd.json \
            -e TZ=Asia/Kolkata \
            -e LOG_JSON=false \
            -e FILE_LOGGING=false \
            -e DEBUG_MODE="$DEBUG_MODE" \
            -e TRIGGER_TIMESTAMP="${{ steps.timestamp.outputs.ts }}" \
            -e GITHUB_SHA="${{ github.sha }}" \
            -e GITHUB_RUN_ID="${{ github.run_id }}" \
            -e GITHUB_RUN_NUMBER="${{ github.run_number }}" \
            -e GITHUB_WORKFLOW="${{ github.workflow }}" \
            -e GITHUB_REPOSITORY="${{ github.repository }}" \
            "$IMAGE"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Bot execution failed"
          echo "üîó Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
