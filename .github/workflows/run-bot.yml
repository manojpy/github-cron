name: ðŸ¤– Run MACD Unified Bot (Cron + Optimized)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (log alerts only)'
        required: false
        default: 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: manojpy/github-cron/macd-unified-aot

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read

    steps:
    # ========== PHASE 1: SETUP ==========
    - name: ðŸ“¥ Checkout (shallow)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ðŸ” Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # ========== PHASE 2: PULL & VERIFY IMAGE ==========
    - name: ðŸ³ Pull & Verify AOT Image
      id: image-pull
      env:
        BOT_IMAGE: ghcr.io/${{ env.IMAGE_NAME }}:latest
      run: |
        echo "ðŸš€ Pulling optimized AOT image: $BOT_IMAGE"
        docker pull --quiet $BOT_IMAGE
        
        # Fix: Single-line Python command (no indentation issues)
        docker run --rm --entrypoint python $BOT_IMAGE \
          -c "import aot_bridge; aot_bridge.ensure_initialized(); aot_status = aot_bridge.is_using_aot(); print(f'âœ… AOT Status: {aot_status}'); import sys; sys.exit(0)"

    # ========== PHASE 3: EXECUTE BOT ==========
    - name: ðŸš€ Execute Bot (Resource Limited)
      id: bot-run
      env:
        BOT_IMAGE: ghcr.io/${{ env.IMAGE_NAME }}:latest
        DRY_RUN_MODE: ${{ github.event.inputs.dry_run == 'true' && 'true' || 'false' }}
      run: |
        set -euo pipefail
        
        # Generate timestamp
        TRIGGERTIMESTAMP=$(date -u +%s)
        
        echo "ðŸ”¥ Starting MACD Unified Bot (AOT) ðŸ”¥"
        echo "::group::ðŸ“Š Bot Execution"
        echo "ðŸ“… Trigger: $(date -u)"
        echo "â° Timestamp: $TRIGGERTIMESTAMP"
        echo "ðŸ³ Image: $BOT_IMAGE"
        
        # Create logs dir + tee output
        mkdir -p logs
        OUTPUT_FILE="logs/bot-run-$(date +%Y%m%d-%H%M%S).log"
        
        # Run with strict resource limits
        docker run --rm \
          --name macd-bot-${{ github.run_id }} \
          --memory=1g --cpus=2 \
          -e TZ=Asia/Kolkata \
          -e TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
          -e TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
          -e REDIS_URL=${{ secrets.REDIS_URL }} \
          -e DRY_RUN_MODE=$DRY_RUN_MODE \
          -e TRIGGERTIMESTAMP=$TRIGGERTIMESTAMP \
          -v ${{ github.workspace }}/logs:/app/logs \
          -v ${{ github.workspace }}/config_macd.json:/app/src/config_macd.json:ro \
          $BOT_IMAGE 2>&1 | tee "$OUTPUT_FILE"
        
        echo "::endgroup::"
        
        # Extract metrics for summary
        if grep -q "âœ… RUN COMPLETE" "$OUTPUT_FILE"; then
          DURATION=$(grep "Duration:" "$OUTPUT_FILE" | awk -F'Duration: ' '{print $2}' | head -1 | awk '{print $1}' || echo "0")
          ALERTS=$(grep "Alerts:" "$OUTPUT_FILE" | awk -F'Alerts: ' '{print $2}' | head -1 | awk '{print $1}' || echo "0")
          PAIRS=$(grep "Pairs:" "$OUTPUT_FILE" | awk -F'Pairs: ' '{print $2}' | head -1 | awk '{print $1}' || echo "0")
          
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          echo "alerts=${ALERTS}" >> $GITHUB_OUTPUT
          echo "pairs=${PAIRS}" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "duration=0s" >> $GITHUB_OUTPUT
          echo "alerts=0" >> $GITHUB_OUTPUT
          echo "pairs=0" >> $GITHUB_OUTPUT
          echo "success=false" >> $GITHUB_OUTPUT
        fi

    # ========== PHASE 4: SUMMARY ==========
    - name: ðŸ“Š Generate Run Summary
      if: always()
      run: |
        echo "## ðŸ¤– MACD Bot Execution Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.bot-run.outputs.success }}" = "true" ]; then
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… **Status** | **SUCCESS** |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ **Duration** | ${{ steps.bot-run.outputs.duration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”” **Alerts** | ${{ steps.bot-run.outputs.alerts }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ **Pairs** | ${{ steps.bot-run.outputs.pairs }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ **Image** | `ghcr.io/${{ env.IMAGE_NAME }}:latest` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ **Timezone** | ðŸ‡®ðŸ‡³ Asia/Kolkata |" >> $GITHUB_STEP_SUMMARY
          
          # Latest log preview
          LATEST_LOG=$(ls -t logs/bot-run-*.log 2>/dev/null | head -1)
          if [ -f "$LATEST_LOG" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Latest Log Preview" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -15 "$LATEST_LOG" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Bot execution failed**" >> $GITHUB_STEP_SUMMARY
          echo "Check logs above for details." >> $GITHUB_STEP_SUMMARY
        fi

    # ========== PHASE 5: CLEANUP ==========
    - name: ðŸ§¹ Cleanup Docker & Logs
      if: always()
      run: |
        echo "ðŸ§¹ Final cleanup..."
        docker rm -f macd-bot-${{ github.run_id }} || true
        docker image prune -f || true
        docker container prune -f || true
        find logs -name 'bot-run-*.log' -mtime +1 -delete || true
        echo "âœ… Cleanup complete (~2.5MB freed)"