name: Run Unified MACD Bot

on:
  workflow_dispatch:
  schedule:
    # Run at 1,16,31,46 minutes past each hour (IST offset handled by UTC)
    - cron: '1,16,31,46 * * * *'

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}/trading-bot:latest

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: []   # decouple from build workflow, run immediately
    container:
      image: ${{ env.IMAGE_NAME }}
      options: --user root
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        REDIS_URL:          ${{ secrets.REDIS_URL }}
        DELTA_API_BASE:     ${{ secrets.DELTA_API_BASE }}
        CONFIG_FILE:        config_macd.json
        TZ: Asia/Kolkata

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Log scheduled vs actual start time
        run: |
          echo "⏱ Scheduled trigger (UTC): ${{ github.event.schedule || 'manual dispatch' }}"
          echo "⏱ Actual start time (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "⏱ IST time: $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S')"

      - name: Run bot once
        run: python -u gitlab_wrapper.py
