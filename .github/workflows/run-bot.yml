name: ðŸ¤– Run MACD Unified Bot (Native Fast-Path)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (log alerts only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  # Note: Triggered via GitHub API from Cron-jobs.org

env:
  PYTHON_VERSION: "3.11"
  AOT_LIB_NAME: "macd_aot_compiled"

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # ========================================================================
      # PHASE 1: SETUP & CACHING
      # ========================================================================
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip' # Automatically caches requirements

      - name: ðŸ—„ï¸ Cache AOT Binary
        id: cache-aot
        uses: actions/cache@v4
        with:
          path: ./${{ env.AOT_LIB_NAME }}.so
          key: aot-${{ runner.os }}-${{ hashFiles('src/numba_functions_shared.py', 'src/aot_build.py') }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ========================================================================
      # PHASE 2: AOT COMPILATION (Only runs on cache miss)
      # ========================================================================
      - name: ðŸ”¨ Build AOT Binary
        if: steps.cache-aot.outputs.cache-hit != 'true'
        run: |
          python src/aot_build.py --output-dir . --module-name ${{ env.AOT_LIB_NAME }} --verify
        env:
          PYTHONOPTIMIZE: 2

      # ========================================================================
      # PHASE 3: EXECUTION
      # ========================================================================
      - name: ðŸš€ Run MACD Bot
        id: bot-run
        env:
          # Secrets from GitHub
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          # Bot Config
          PYTHONPATH: ./src
          PYTHONOPTIMIZE: 2
          AOT_STRICT: 1
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          mkdir -p logs
          # Run the bot and pipe output to both console and log file
          python src/macd_unified.py --skip-warmup 2>&1 | tee logs/bot.log
          
          # Extract metadata for summary (Native replacement for docker logs)
          echo "DURATION=$(grep -oP 'Bot run completed in \K[0-9.]+' logs/bot.log || echo '0')" >> $GITHUB_ENV
          echo "ALERTS=$(grep -c "Alert condition met" logs/bot.log || echo '0')" >> $GITHUB_ENV

      # ========================================================================
      # PHASE 4: REPORTING
      # ========================================================================
      - name: ðŸ“ Generate Summary Report
        if: always()
        run: |
          STATUS="${{ steps.bot-run.outcome }}"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– MACD Bot Execution Report
          | Metric | Value |
          | :--- | :--- |
          | **Status** | ${{ steps.bot-run.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} |
          | **Duration** | ${{ env.DURATION }}s |
          | **Alerts Sent** | ${{ env.ALERTS }} |
          | **Numba Mode** | âš¡ AOT (Compiled) |
          | **Cache Status** | ${{ steps.cache-aot.outputs.cache-hit == 'true' && 'ðŸŽ¯ Hit' || 'ðŸ› ï¸ Rebuilt' }} |
          EOF

      - name: ðŸ“¦ Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bot-error-logs
          path: logs/
          retention-days: 3