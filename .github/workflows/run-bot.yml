name: Run MACD Bot

on:
  workflow_dispatch:      

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup and Execute Bot
        id: bot_run
        run: |
          echo "ðŸ”¥ Launching Macd Unified ðŸ”¥ðŸš€"
          echo "::group::ðŸ”„ Pulling Latest AOT Image"
          docker pull --quiet ghcr.io/manojpy/github-cron/macd-unified-aot:latest
          echo "::endgroup::"



- name: Setup and Execute Bot
  id: bot_run
  run: |
    echo "ðŸ”¥ Launching Macd Unified ðŸ”¥ðŸš€"
    echo "::group::ðŸ”„ Pulling Latest AOT Image"
    docker pull --quiet ghcr.io/manojpy/github-cron/macd-unified-aot:latest
    echo "::endgroup::"

          # Run the bot with IST Timezone
          docker run --rm \
            --name macd_bot_container \
            -e TZ=Asia/Kolkata \
            -e TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }} \
            -e TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }} \
            -e REDIS_URL=${{ secrets.REDIS_URL }} \
            -v ${{ github.workspace }}/config_macd.json:/app/src/config_macd.json \
            ghcr.io/manojpy/github-cron/macd-unified-aot:latest | tee bot_output.log

      - name: Generate Job Summary
        if: always()
        run: |
          echo "### ðŸš€ MACD Bot Run Results (IST)" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "âœ… RUN COMPLETE" bot_output.log; then
            # Parsing values from your specific log format
            DURATION=$(grep "Duration:" bot_output.log | awk -F'Duration: ' '{print $2}' | awk '{print $1}')
            ALERTS=$(grep "Alerts:" bot_output.log | awk -F'Alerts: ' '{print $2}' | awk '{print $1}')
            PAIRS=$(grep "Pairs:" bot_output.log | awk -F'Pairs: ' '{print $2}' | awk '{print $1}')
            
            echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Timezone** | ðŸ‡®ðŸ‡³ IST (Asia/Kolkata) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Execution** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            echo "| **Pairs Processed** | $PAIRS |" >> $GITHUB_STEP_SUMMARY
            echo "| **Duration** | $DURATION |" >> $GITHUB_STEP_SUMMARY
            echo "| **Alerts Sent** | $ALERTS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Run Failed or Timed Out**" >> $GITHUB_STEP_SUMMARY
            echo "Please check the 'Setup and Execute Bot' logs for details." >> $GITHUB_STEP_SUMMARY
          fi