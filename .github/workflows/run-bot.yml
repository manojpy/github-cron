name: ü§ñ Run MACD Unified Bot (Hybrid)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (log alerts only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_alerts:
        description: 'Skip Telegram alerts (test mode)'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: manojpy/github-cron/macd-unified-aot
  BOT_TIMEOUT: 330

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 8
    permissions:
      contents: read
      packages: read

    steps:
      # PHASE 1: SETUP & VALIDATION
      - name: üî• Checkout Config Only
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            config_macd.json
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ‚úÖ Verify Config File Exists
        run: |
          if [ ! -f "config_macd.json" ]; then
            echo "‚ùå ERROR: config_macd.json not found in repo root"
            echo ""
            echo "Please create config_macd.json with your settings and commit it."
            echo "Example structure:"
            cat << 'EOF'
          {
            "TELEGRAM_BOT_TOKEN": "your_token_here",
            "TELEGRAM_CHAT_ID": "your_chat_id_here",
            "REDIS_URL": "redis://user:pass@host:port",
            "DELTA_API_BASE": "https://api.example.com",
            "PAIRS": ["BTCUSD", "ETHUSD", "AVAXUSD"],
            "DRY_RUN_MODE": false
          }
          EOF
            exit 1
          fi
          
          echo "‚úÖ Config file found"
          FILE_SIZE=$(wc -c < config_macd.json)
          echo "   Size: $FILE_SIZE bytes"
          
          if python -m json.tool config_macd.json > /dev/null 2>&1; then
            echo "‚úÖ Config is valid JSON"
          else
            echo "‚ùå Config is not valid JSON - please fix syntax errors"
            exit 1
          fi

      - name: üîê Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Pull Latest AOT Image
        run: |
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "üî¶ Pulling AOT image..."
          START_TIME=$(date +%s)
          export DOCKER_BUILDKIT=1
          if docker pull --quiet --platform linux/amd64 "$IMAGE_REF"; then
            PULL_TIME=$(( $(date +%s) - START_TIME ))
            echo "‚úÖ Image pulled in ${PULL_TIME}s"
          else
            echo "‚ùå Failed to pull image"
            exit 1
          fi

      - name: üîë Verify Secrets
        run: |
          MISSING=()
          [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && MISSING+=("TELEGRAM_BOT_TOKEN")
          [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ] && MISSING+=("TELEGRAM_CHAT_ID")
          [ -z "${{ secrets.REDIS_URL }}" ] && MISSING+=("REDIS_URL")
          [ -z "${{ secrets.DELTA_API_BASE }}" ] && MISSING+=("DELTA_API_BASE")
          
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "‚ùå Missing required secrets: ${MISSING[*]}"
            echo ""
            echo "Add these to GitHub Repository Settings > Secrets and variables > Actions:"
            for secret in "${MISSING[@]}"; do
              echo "  - $secret"
            done
            exit 1
          fi
          echo "‚úÖ All required secrets configured"

      # PHASE 2: BOT EXECUTION
      - name: üöÄ Execute MACD Bot
        id: bot_run
        timeout-minutes: 7
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          mkdir -p logs
          echo "::group::üî• Launch Macd-Unified...üî•"
          echo "üïê Trigger Time: $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S IST')"
          echo "üè∑Ô∏è Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "üß™ Dry Run: $DRY_RUN"
          echo "::endgroup::"

          START_TIME=$(date +%s)
          timeout --signal=SIGTERM --kill-after=15s ${{ env.BOT_TIMEOUT }}s docker run \
            --rm \
            --name macd_bot_runner \
            --platform linux/amd64 \
            --network host \
            --memory="900m" \
            --memory-swap="1800m" \
            --cpus="2.0" \
            --security-opt=no-new-privileges \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=64m \
            --tmpfs /home/appuser/.cache:rw,noexec,nosuid,size=32m \
            -e TZ=Asia/Kolkata \
            -e PYTHONPATH=/app/src:$PYTHONPATH \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DELTA_API_BASE="${{ secrets.DELTA_API_BASE }}" \
            -e DRY_RUN_MODE="$DRY_RUN" \
            -e PYTHONUNBUFFERED=1 \
            -e NUMBA_NUM_THREADS=2 \
            -e OMP_NUM_THREADS=2 \
            -v "${{ github.workspace }}/config_macd.json:/app/src/config_macd.json:ro" \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest 2>&1 | tee logs/bot_output.log

          EXIT_CODE=${PIPESTATUS[0]}
          DURATION=$(( $(date +%s) - START_TIME ))
          echo "execution_time=${DURATION}" >> $GITHUB_OUTPUT
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 124 ] || [ $EXIT_CODE -eq 137 ]; then
            echo "‚ö†Ô∏è Bot execution timed out after ${DURATION}s"
            exit 1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Bot exited with code $EXIT_CODE"
            exit 1
          fi
          echo "‚úÖ Bot completed successfully in ${DURATION}s"

      # PHASE 3: RESULTS ANALYSIS
      - name: üìä Parse Execution Results
        if: always()
        id: results
        run: |
          LOG_FILE="logs/bot_output.log"
          if [ ! -f "$LOG_FILE" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "message=Log file not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if grep -q "RUN COMPLETE" "$LOG_FILE"; then
            STATUS="success"
            DURATION=$(grep -oP "Duration:\s*\K[\d.]+(?=s)" "$LOG_FILE" | head -1 || echo "N/A")
            ALERTS=$(grep -oP "(?:Alerts|Sent):\s*\K\d+" "$LOG_FILE" | head -1 || echo "0")
            PAIRS=$(grep -oP "Pairs:\s*\K[\d/]+" "$LOG_FILE" | head -1 || echo "N/A")
            MEMORY=$(grep -oP "Memory:\s*\K\d+MB" "$LOG_FILE" | head -1 || echo "N/A")
            REDIS_STATUS=$(grep -oP "Redis:\s*\K\w+" "$LOG_FILE" | head -1 || echo "UNKNOWN")
          else
            STATUS="failed"
            ERROR_MSG=$(grep -E "FATAL ERROR|Bot run failed|Error|ERROR" "$LOG_FILE" | head -1 | cut -c1-120 || echo "Unknown error")
          fi
          
          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "duration=${DURATION:-N/A}" >> $GITHUB_OUTPUT
          echo "alerts=${ALERTS:-0}" >> $GITHUB_OUTPUT
          echo "pairs=${PAIRS:-N/A}" >> $GITHUB_OUTPUT
          echo "memory=${MEMORY:-N/A}" >> $GITHUB_OUTPUT
          echo "redis_status=${REDIS_STATUS:-UNKNOWN}" >> $GITHUB_OUTPUT
          echo "error_msg=${ERROR_MSG:-None}" >> $GITHUB_OUTPUT

      - name: üìã Generate Summary Report
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ü§ñ MACD Bot Execution Report
          
          | Metric | Value |
          |--------|-------|
          | **Status** | ${{ steps.results.outputs.status }} |
          | **Duration** | ${{ steps.results.outputs.duration }}s |
          | **Alerts** | ${{ steps.results.outputs.alerts }} |
          | **Pairs** | ${{ steps.results.outputs.pairs }} |
          | **Memory** | ${{ steps.results.outputs.memory }} |
          | **Redis** | ${{ steps.results.outputs.redis_status }} |
          
          EOF
          
          if [ "${{ steps.results.outputs.status }}" != "success" ]; then
            echo "### ‚ùå Error Details" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.results.outputs.error_msg }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Run Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- üì° Duration: ${{ steps.results.outputs.duration }}s" >> $GITHUB_STEP_SUMMARY
            echo "- üìä Alerts Sent: ${{ steps.results.outputs.alerts }}" >> $GITHUB_STEP_SUMMARY
            echo "- üìà Pairs Scanned: ${{ steps.results.outputs.pairs }}" >> $GITHUB_STEP_SUMMARY
            echo "- üíæ Memory Used: ${{ steps.results.outputs.memory }}" >> $GITHUB_STEP_SUMMARY
            echo "- üóÑÔ∏è Redis Status: ${{ steps.results.outputs.redis_status }}" >> $GITHUB_STEP_SUMMARY
          fi

      # PHASE 4: ARTIFACT UPLOAD
      - name: üì¶ Upload Execution Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bot-execution-logs-${{ github.run_number }}
          path: logs/
          retention-days: 2
          compression-level: 9