# .github/workflows/macd-bot.yml
name: MACD Unified Bot

# Triggered by Cron-Jobs.org webhook at :01, :16, :31, :46 every hour
on:
  repository_dispatch:
    types: [cron_trigger]
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

# Prevent overlapping runs (critical for Redis lock)
concurrency:
  group: macd-bot-single-run
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-24.04  # 2025: ~20% faster than ubuntu-latest
    timeout-minutes: 10
    permissions:
      packages: read
      deployments: write
      contents: read

    steps:
      - name: Log Trigger Info
        run: |
          echo "Triggered via: ${{ github.event_name }}"
          echo "UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "IST: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"
          echo "Run ID: ${{ github.run_id }}"
          echo "Debug Mode: ${{ inputs.debug_mode || 'false' }}"

      - name: Checkout config only (sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: config_macd.json
          sparse-checkout-cone-mode: false

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Latest Bot Image
        id: pull
        run: |
          IMAGE="ghcr.io/${{ github.repository }}/trading-bot:latest"
          echo "Pulling $IMAGE..."
          if docker pull "$IMAGE"; then
            echo "Image pulled successfully"
            docker inspect "$IMAGE" --format='Created: {{.Created}}'
            echo "image_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Failed to pull image"
            echo "image_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate Trigger Timestamp
        id: ts
        run: |
          TS=$(date +%s)
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "Trigger timestamp: \( TS â†’ \)(date -d @$TS -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Validate Config
        run: |
          if [ ! -f config_macd.json ]; then
            echo "config_macd.json not found!"
            exit 1
          fi
          echo "Config found"

      - name: Run MACD Bot
        id: bot
        env:
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          TRIGGER_TIMESTAMP: ${{ steps.ts.outputs.ts }}
        run: |
          set +x  # Hide secrets
          docker run --rm \
            --name macd-bot-${{ github.run_id }} \
            --memory="512m" \
            --cpus="1.5" \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=100m \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DELTA_API_BASE="${{ secrets.DELTA_API_BASE }}" \
            -e CONFIG_FILE=/app/config_macd.json \
            -e DEBUG_MODE="$DEBUG_MODE" \
            -e TRIGGER_TIMESTAMP="$TRIGGER_TIMESTAMP" \
            -e TZ=Asia/Kolkata \
            -v "$(pwd)/config_macd.json:/app/config_macd.json:ro" \
            ghcr.io/${{ github.repository }}/trading-bot:latest

          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Success Notification
        if: success()
        run: |
          echo "Bot completed successfully in ${{ job.duration }} seconds"

      - name: Failure Alert to Telegram
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="Bot FAILED!%0A"
          MSG+="Run: https://github.com/\( {{ github.repository }}/actions/runs/ \){{ github.run_id }}%0A"
          MSG+="Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="Exit Code: ${{ steps.bot.outputs.exit_code }}%0A"
          MSG="Debug: ${{ inputs.debug_mode || 'false' }}"
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT" \
            -d text="$MSG" \
            -d parse_mode="HTML"

      - name: Cleanup
        if: always()
        run: |
          docker system prune -f --volumes || true