name: ðŸ¤– Run MACD Unified Bot (Native Fast-Path)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode'
        required: false
        default: 'false'
        type: boolean
  # This allows Cron-jobs.org to trigger via GitHub API
  repository_dispatch:
    types: [trigger-bot]

env:
  PYTHON_VERSION: "3.11"
  AOT_LIB_NAME: "macd_aot_compiled"

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # ========================================================================
      # PHASE 1: ENVIRONMENT SETUP
      # ========================================================================
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip' # Caches requirements.txt automatically

      - name: ðŸ—„ï¸ Cache AOT Binary
        id: cache-aot
        uses: actions/cache@v4
        with:
          path: ./${{ env.AOT_LIB_NAME }}.so
          # Key changes if core logic or dependencies change
          key: aot-${{ runner.os }}-${{ hashFiles('src/numba_functions_shared.py', 'src/aot_build.py', 'requirements.txt') }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ========================================================================
      # PHASE 2: AOT COMPILATION (Skips if Cache Hit)
      # ========================================================================
      - name: ðŸ”¨ Build AOT Binary
        if: steps.cache-aot.outputs.cache-hit != 'true'
        run: python src/aot_build.py --output-dir . --module-name ${{ env.AOT_LIB_NAME }}

      # ========================================================================
      # PHASE 3: BOT EXECUTION
      # ========================================================================
      - name: ðŸš€ Run MACD Bot
        id: bot-run
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          PYTHONPATH: ./src
          PYTHONOPTIMIZE: 2
          AOT_STRICT: 1
          # Pass dry-run input if it exists, else default to false
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          mkdir -p logs
          # Run bot and pipe all output to log file
          python src/macd_unified.py --skip-warmup 2>&1 | tee logs/bot.log
          
          # FIXED LOG PARSING:
          # Your bot logs: "âœ… RUN COMPLETE | Duration: 8.0s | Pairs: 12/12 | Alerts: 2"
          SUMMARY_LINE=$(tail -n 15 logs/bot.log | grep "RUN COMPLETE")
          
          # Extract values using regex that matches your specific log format
          DURATION=$(echo "$SUMMARY_LINE" | grep -oP 'Duration: \K[0-9.]+' || echo "0")
          ALERTS=$(echo "$SUMMARY_LINE" | grep -oP 'Alerts: \K[0-9]+' || echo "0")
          PAIRS=$(echo "$SUMMARY_LINE" | grep -oP 'Pairs: \K[0-9/]+' || echo "N/A")
          
          # Save to environment for the summary step
          echo "BOT_DURATION=$DURATION" >> $GITHUB_ENV
          echo "BOT_ALERTS=$ALERTS" >> $GITHUB_ENV
          echo "BOT_PAIRS=$PAIRS" >> $GITHUB_ENV

      # ========================================================================
      # PHASE 4: RESULTS SUMMARY
      # ========================================================================
      - name: ðŸ“ Generate Summary Report
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– MACD Bot Execution Report
          | Metric | Value |
          | :--- | :--- |
          | **Execution Status** | ${{ steps.bot-run.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} |
          | **Bot Logic Time** | ${{ env.BOT_DURATION }}s |
          | **Alerts Sent** | ${{ env.BOT_ALERTS }} |
          | **Pairs Processed** | ${{ env.BOT_PAIRS }} |
          | **Optimization** | âš¡ AOT-Compiled (Native) |
          | **AOT Library** | ${{ steps.cache-aot.outputs.cache-hit == 'true' && 'ðŸŽ¯ From Cache' || 'ðŸ”¨ Freshly Built' }} |
          EOF

      - name: ðŸ“¦ Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bot-error-logs
          path: logs/
          retention-days: 3