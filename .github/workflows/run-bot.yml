name: Run Unified MACD Bot

on:
  workflow_dispatch:
  repository_dispatch:
    types: [cron_trigger]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    # INCREASED: 12 mins is too risky for a 10 min internal timeout + queue lag.
    # 25 mins guarantees the container won't be hard-killed by GitHub while waiting.
    timeout-minutes: 25
    
    permissions:
      packages: read

    steps:
      - name: Log execution time
        run: |
          echo "⏱ Triggered via: ${{ github.event_name }}"
          echo "⏱ UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "⏱ IST: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"

      - name: Checkout (for config file)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            config_macd.json

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest image
        run: |
          docker pull ghcr.io/${{ github.repository }}/trading-bot:latest

      # ADDED: Calculate the specific Unix timestamp of the trigger.
      # This helps future-proof the bot to know exactly WHEN it started 
      # regardless of how long GitHub takes to queue the job.
      - name: Set Trigger Timestamp
        id: timestamp
        run: echo "ts=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Run bot once
        run: |
          docker run --rm \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e DELTA_API_BASE="${{ secrets.DELTA_API_BASE }}" \
            -e CONFIG_FILE=config_macd.json \
            -e TZ=Asia/Kolkata \
            -e LOG_JSON=false \
            -e FILE_LOGGING=false \
            -e GITHUB_SHA="${{ github.sha }}" \
            -e GITHUB_RUN_ID="${{ github.run_id }}" \
            -e GITHUB_RUN_NUMBER="${{ github.run_number }}" \
            -e GITHUB_WORKFLOW="${{ github.workflow }}" \
            -e WORKFLOW_TRIGGER_TS="${{ steps.timestamp.outputs.ts }}" \
            -v "$(pwd)/config_macd.json:/app/config_macd.json:ro" \
            ghcr.io/${{ github.repository }}/trading-bot:latest

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Bot execution failed at $(date)"
          echo "Check logs at: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 