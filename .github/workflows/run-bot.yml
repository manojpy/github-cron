name: Run Unified MACD Bot

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [cron_trigger]

concurrency:
  group: trading-bot-execution
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    # Reduced timeout as native execution is much faster
    timeout-minutes: 5
    
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Log execution context
        run: |
          echo "üöÄ Triggered via: ${{ github.event_name }}"
          echo "‚è∞ UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "‚è∞ IST Time: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"

      # OPTIMIZED: Checkout full code (needed for native run)
      - name: Checkout code
        uses: actions/checkout@v4

      # OPTIMIZED: Setup uv for lightning-fast dependency install
      - name: Install uv
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"

      # OPTIMIZED: Setup Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # OPTIMIZED: Install dependencies directly (No Docker overhead)
      # Replicates the specific pycares/aiodns fix from your Dockerfile
      - name: Install dependencies
        run: |
          uv pip install --system pycares==4.4.0 aiodns==3.2.0
          uv pip install --system -r requirements.txt

      - name: Set trigger timestamp
        id: timestamp
        run: |
          TS=$(date +%s)
          echo "ts=$TS" >> $GITHUB_OUTPUT

      # OPTIMIZED: Run Python directly on "Bare Metal"
      # No CPU limits, No Memory limits (Runner has 7GB RAM / 2 vCPUs)
      - name: Run trading bot
        id: run_bot
        env:
          # Secrets
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          DELTA_API_BASE: ${{ secrets.DELTA_API_BASE }}
          # Config
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          CONFIG_FILE: config_macd.json
          TZ: Asia/Kolkata
          # Metadata
          TRIGGER_TIMESTAMP: ${{ steps.timestamp.outputs.ts }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ü§ñ Starting trading bot (Native Mode)..."
          python wrapper.py

      # Reporting
      - name: Log execution summary
        if: always()
        run: |
          echo "üìä Execution Summary:"
          echo "  - Status: ${{ job.status }}"
          echo "  - Duration: $(date)"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Bot execution failed"
          echo "üîó Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"