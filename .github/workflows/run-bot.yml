name: Run Unified MACD Bot (Optimized Native)

on:
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  # Used by cron-jobs.org or external cron services
  repository_dispatch:
    types: [cron_trigger]

concurrency:
  group: trading-bot-execution
  cancel-in-progress: false

jobs:
  run-bot:
    # --- IMPROVEMENT: Pinning to Ubuntu 24.04 LTS for stability and predictability ---
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Log execution context
        run: |
          echo "üöÄ Triggered via: ${{ github.event_name }}"
          echo "‚è∞ UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "‚è∞ IST Time: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"

      # 1. Checkout full code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup uv for lightning-fast dependency install
      - name: Install uv and Restore Cache
        uses: astral-sh/setup-uv@v1
        with:
          enable-cache: true
          cache-dependency-glob: "requirements.txt"
        # CRITICAL FIX: Skip this step if the cache service fails (the intermittent GitHub error)
        continue-on-error: true 

      # 3. Setup Python 3.11
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4. Install dependencies directly on the runner
      - name: Install dependencies (uv)
        run: |
          echo "Installing Python dependencies..."
          # Fix the pycares / aiodns issue locally
          uv pip install --system pycares==4.4.0 aiodns==3.2.0
          # Install everything else from requirements.txt
          uv pip install --system -r requirements.txt

      - name: Set trigger timestamp
        id: timestamp
        run: |
          TS=$(date +%s)
          echo "ts=$TS" >> $GITHUB_OUTPUT

      # 5. Run Python directly
      - name: Run trading bot (Native Execution)
        id: run_bot
        env:
          # Secrets (retrieved from GitHub Secrets)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          DELTA_API_BASE: ${{ secrets.DELTA_API_BASE }}
          # Config & Metadata
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          CONFIG_FILE: config_macd.json
          TZ: Asia/Kolkata
          TRIGGER_TIMESTAMP: ${{ steps.timestamp.outputs.ts }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          echo "ü§ñ Starting wrapper.py..."
          python wrapper.py

      # Reporting
      - name: Log execution summary
        if: always()
        run: echo "üìä Execution Status: ${{ job.status }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Bot execution failed"
          echo "üîó Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"