name: ðŸ¤– Run MACD Unified Bot (Optimized v2)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run mode (log alerts only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_alerts:
        description: 'Skip Telegram alerts (test mode)'
        required: false
        default: 'false'
        type: boolean
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: manojpy/github-cron/macd-unified-aot
  BOT_TIMEOUT: '300'          # stringified

jobs:
  run-bot:
    runs-on: ubuntu-24.04
    timeout-minutes: 7
    permissions:
      contents: read
      packages: read

    steps:
      # ------------------------------------------------------------------
      # 1.  Checkout only the config file (ultra-fast)
      # ------------------------------------------------------------------
      - name: ðŸ“¥ Checkout Config Only
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            config_macd.json
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      # ------------------------------------------------------------------
      # 2.  Log in to GHCR
      # ------------------------------------------------------------------
      - name: ðŸ” Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------
      # 3.  Pull image (with quoted outputs)
      # ------------------------------------------------------------------
      - name: ðŸ³ Pull Latest AOT Image
        id: image_pull
        run: |
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          START_TIME=$(date +%s)

          if docker image inspect "$IMAGE_REF" >/dev/null 2>&1; then
            CACHED='true'
          else
            CACHED='false'
          fi

          if docker pull --quiet --platform linux/amd64 "$IMAGE_REF"; then
            END_TIME=$(date +%s)
            PULL_TIME=$((END_TIME - START_TIME))
            printf 'pull_time=%s\n' "$PULL_TIME"   >> $GITHUB_OUTPUT
            printf 'cached=%s\n'    "$CACHED"      >> $GITHUB_OUTPUT
            printf 'image_ref=%s\n' "$IMAGE_REF"   >> $GITHUB_OUTPUT
          else
            echo "::error::Failed to pull image"
            exit 1
          fi

      # ------------------------------------------------------------------
      # 4.  Verify secrets
      # ------------------------------------------------------------------
      - name: ðŸ”’ Verify Secrets
        run: |
          MISSING=()
          [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && MISSING+=('TELEGRAM_BOT_TOKEN')
          [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]   && MISSING+=('TELEGRAM_CHAT_ID')
          [ -z "${{ secrets.REDIS_URL }}" ]          && MISSING+=('REDIS_URL')

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "::error::Missing secrets: ${MISSING[*]}"
            exit 1
          fi
          echo 'âœ… All secrets configured'

      # ------------------------------------------------------------------
      # 5.  Pre-warm (quoted output)
      # ------------------------------------------------------------------
      - name: ðŸ”¥ Pre-warm Container
        id: prewarm
        timeout-minutes: 1
        run: |
          START_TIME=$(date +%s)
          docker run --rm --platform linux/amd64 \
            ${{ steps.image_pull.outputs.image_ref }} \
            python -c "import aot_bridge, numpy; print('âœ… Prewarmed')" >/dev/null 2>&1 || true
          END_TIME=$(date +%s)
          PREWARM_TIME=$((END_TIME - START_TIME))
          printf 'prewarm_time=%s\n' "$PREWARM_TIME" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 6.  Run the bot (quoted exit code & duration)
      # ------------------------------------------------------------------
      - name: ðŸš€ Execute MACD Bot
        id: bot_run
        timeout-minutes: 6
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: |
          mkdir -p logs
          START_TIME=$(date +%s)

          # shellcheck disable=SC2024
          timeout --signal=SIGTERM --kill-after=15s ${{ env.BOT_TIMEOUT }}s \
          docker run --rm \
            --name macd_bot_runner \
            --platform linux/amd64 \
            --memory='900m' \
            --memory-swap='900m' \
            --cpus='2.0' \
            --security-opt=no-new-privileges \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=80m \
            --tmpfs /home/appuser/.cache:rw,noexec,nosuid,size=20m \
            -e TZ=Asia/Kolkata \
            -e TELEGRAM_BOT_TOKEN='${{ secrets.TELEGRAM_BOT_TOKEN }}' \
            -e TELEGRAM_CHAT_ID='${{ secrets.TELEGRAM_CHAT_ID }}' \
            -e REDIS_URL='${{ secrets.REDIS_URL }}' \
            -e DRY_RUN_MODE="$DRY_RUN" \
            -e DEBUG_MODE="$DEBUG_MODE" \
            -e PYTHONUNBUFFERED='1' \
            -e NUMBA_NUM_THREADS='2' \
            -e OMP_NUM_THREADS='2' \
            -e TRIGGER_TIMESTAMP="$(date +%s)" \
            -v '${{ github.workspace }}/config_macd.json:/app/src/config_macd.json:ro' \
            ${{ steps.image_pull.outputs.image_ref }} \
            2>&1 | tee logs/bot_output.log

          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          printf 'execution_time=%s\n' "$DURATION" >> $GITHUB_OUTPUT
          printf 'exit_code=%s\n'      "$EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Bot exited with code $EXIT_CODE"
            exit 1
          fi

      # ------------------------------------------------------------------
      # 7.  Parse results â€“ ALL values quoted
      # ------------------------------------------------------------------
      - name: ðŸ“Š Parse Execution Results
        if: always()
        id: results
        run: |
          LOG_FILE='logs/bot_output.log'
          if [ ! -f "$LOG_FILE" ]; then
            printf 'status=%s\n' 'error'     >> $GITHUB_OUTPUT
            printf 'message=%s\n' 'Log file not found' >> $GITHUB_OUTPUT
            exit 0
          fi

          awk '
            /âœ… RUN COMPLETE/ { status = "success" }
            /Duration:/ && status == "success" { match($0, /Duration: ([0-9.]+)s/, arr); duration = arr[1] }
            /Alerts:/ && status == "success"   { match($0, /Alerts: ([0-9]+)/,   arr); alerts   = arr[1] }
            /Pairs:/ && status == "success"    { match($0, /Pairs: ([0-9/]+)/,  arr); pairs    = arr[1] }
            /Memory:/ && status == "success"   { match($0, /Memory: ([0-9]+MB)/, arr); memory   = arr[1] }
            /Redis:/ && status == "success"    { match($0, /Redis: ([A-Z]+)/,    arr); redis_st = arr[1] }
            /FATAL ERROR/ { status = "failed"; getline; err = substr($0,1,100) }
            /Bot run failed/ { status = "failed"; err = "Bot run failed - check logs" }
            END {
              if (status == "") status = "timeout"
              if (duration == "") duration = "N/A"
              if (alerts == "")   alerts   = "0"
              if (pairs == "")    pairs    = "N/A"
              if (memory == "")   memory   = "N/A"
              if (redis_st == "") redis_st = "UNKNOWN"
              if (err == "")      err      = "None"
              printf "status=%s\n",       status
              printf "duration=%s\n",     duration
              printf "alerts=%s\n",       alerts
              printf "pairs=%s\n",        pairs
              printf "memory=%s\n",       memory
              printf "redis_status=%s\n", redis_st
              printf "error_msg=%s\n",    err
            }
          ' "$LOG_FILE" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 8.  Alert details â€“ quoted
      # ------------------------------------------------------------------
      - name: ðŸ“ˆ Extract Alert Details
        if: success() && steps.results.outputs.status == 'success'
        id: alert_details
        run: |
          LOG_FILE='logs/bot_output.log'
          PPO=$(grep -c 'PPO cross'   "$LOG_FILE" 2>/dev/null || echo '0')
          RSI=$(grep -c 'RSI cross'   "$LOG_FILE" 2>/dev/null || echo '0')
          VWAP=$(grep -c 'VWAP'       "$LOG_FILE" 2>/dev/null || echo '0')
          MMH=$(grep -c 'MMH Reversal' "$LOG_FILE" 2>/dev/null || echo '0')
          PIVOT=$(grep -c 'Cross above\|Cross below' "$LOG_FILE" 2>/dev/null || echo '0')

          printf 'ppo_alerts=%s\n'   "$PPO"   >> $GITHUB_OUTPUT
          printf 'rsi_alerts=%s\n'   "$RSI"   >> $GITHUB_OUTPUT
          printf 'vwap_alerts=%s\n'  "$VWAP"  >> $GITHUB_OUTPUT
          printf 'mmh_alerts=%s\n'   "$MMH"   >> $GITHUB_OUTPUT
          printf 'pivot_alerts=%s\n' "$PIVOT" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 9.  Summary & artifacts â€“ quoted where needed
      # ------------------------------------------------------------------
      - name: ðŸ“ Generate Comprehensive Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ¤– MACD Bot Execution Report

          | Metric | Value |
          |--------|-------|
          | **Status** | ${{ steps.results.outputs.status == 'success' && 'âœ… Success' || steps.results.outputs.status == 'failed' && 'âŒ Failed' || 'â±ï¸ Timeout' }} |
          | **Duration** | ${{ steps.results.outputs.duration }}s |
          | **Pairs Processed** | ${{ steps.results.outputs.pairs }} |
          | **Total Alerts** | ${{ steps.results.outputs.alerts }} |
          | **Memory Peak** | ${{ steps.results.outputs.memory }} |
          | **Redis Status** | ${{ steps.results.outputs.redis_status }} |

          EOF

          if [ "${{ steps.results.outputs.status }}" = 'success' ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ðŸ“ˆ Alert Breakdown
          | Type | Count |
          |------|-------|
          | PPO Signals | ${{ steps.alert_details.outputs.ppo_alerts }} |
          | RSI Crosses | ${{ steps.alert_details.outputs.rsi_alerts }} |
          | VWAP | ${{ steps.alert_details.outputs.vwap_alerts }} |
          | MMH Reversals | ${{ steps.alert_details.outputs.mmh_alerts }} |
          | Pivot Levels | ${{ steps.alert_details.outputs.pivot_alerts }} |

          EOF
          fi

      # ------------------------------------------------------------------
      # 10. Upload logs only on failure or debug
      # ------------------------------------------------------------------
      - name: ðŸ“¦ Upload Execution Logs
        if: failure() || github.event.inputs.debug_mode == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: logs/
          retention-days: 3
          compression-level: 9

      # ------------------------------------------------------------------
      # 11. Lightweight cleanup
      # ------------------------------------------------------------------
      - name: ðŸ§¹ Cleanup Resources
        if: always()
        run: |
          docker stop macd_bot_runner macd_prewarm 2>/dev/null || true
          docker rm   macd_bot_runner macd_prewarm 2>/dev/null || true
          echo 'âœ… Cleanup complete (image cache preserved)'
