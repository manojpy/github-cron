name: Bot Watchdog Monitor

on:
  schedule:
    - cron: '5 * * * *'   # Every hour at minute 5
  workflow_dispatch:       # Allow manual run too

jobs:
  watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Run Watchdog Check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python <<'PYCODE'
          import os, time, requests, json

          TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
          CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

          def send_alert(msg):
              try:
                  r = requests.post(
                      f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                      data={"chat_id": CHAT_ID, "text": msg, "parse_mode": "HTML"},
                      timeout=10
                  )
                  if r.status_code != 200:
                      print("Telegram send failed:", r.text)
              except Exception as e:
                  print("Error sending Telegram:", e)

          def check_file_age(path, label, threshold_hours=2):
              """Return (status, age_hours)."""
              if not os.path.exists(path):
                  send_alert(f"âš ï¸ Watchdog Alert: {label} state file not found!")
                  return False, None
              age_hours = (time.time() - os.path.getmtime(path)) / 3600
              if age_hours > threshold_hours:
                  send_alert(f"âš ï¸ Watchdog Alert: {label} last updated {age_hours:.1f}h ago.")
                  return False, age_hours
              print(f"{label}: OK ({age_hours:.2f}h old)")
              return True, age_hours

          macd_ok, macd_age = check_file_age("macd_state.sqlite", "MACD Bot", 2)
          fib_ok, fib_age   = check_file_age("fib_state.sqlite", "Fibonacci Pivot Bot", 2)

          # ------------------------------------------------------------
          # Daily heartbeat message â€” once every 24 hours
          # ------------------------------------------------------------
          state_file = ".watchdog_state.json"
          now = time.time()
          last_ping_time = 0
          if os.path.exists(state_file):
              try:
                  with open(state_file, "r") as f:
                      last_ping_time = json.load(f).get("last_ping", 0)
              except Exception:
                  last_ping_time = 0

          hours_since_last_ping = (now - last_ping_time) / 3600
          if hours_since_last_ping >= 24:
              if macd_ok and fib_ok:
                  msg = (
                      "âœ… <b>Watchdog Daily Health Check</b>\n"
                      f"All systems OK.\n"
                      f"â€¢ MACD Bot: {macd_age:.2f} h old\n"
                      f"â€¢ Fibonacci Bot: {fib_age:.2f} h old\n"
                      "Everything running smoothly ðŸš€"
                  )
                  send_alert(msg)
              with open(state_file, "w") as f:
                  json.dump({"last_ping": now}, f)
          else:
              print(f"Last heartbeat was {hours_since_last_ping:.1f} h ago; skipping daily ping.")

          print("âœ… Watchdog check complete.")
          PYCODE
