name: Bot Watchdog Monitor

on:
  schedule:
    - cron: '5 * * * *'   # Every hour at minute 5
  workflow_dispatch:       # Allow manual run too

jobs:
  watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Run Watchdog Check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python <<'PYCODE'
          import os, time, requests, sys

          TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
          CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

          def send_alert(msg):
              try:
                  r = requests.post(
                      f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                      data={"chat_id": CHAT_ID, "text": msg, "parse_mode": "HTML"},
                      timeout=10
                  )
                  if r.status_code != 200:
                      print("Telegram alert failed:", r.text)
              except Exception as e:
                  print("Error sending Telegram:", e)

          def check_file_age(path, label, threshold_hours=2):
              if not os.path.exists(path):
                  send_alert(f"⚠️ Watchdog Alert: {label} state file not found!")
                  return
              age_hours = (time.time() - os.path.getmtime(path)) / 3600
              if age_hours > threshold_hours:
                  send_alert(f"⚠️ Watchdog Alert: {label} last updated {age_hours:.1f}h ago.")
              else:
                  print(f"{label}: OK ({age_hours:.2f}h old)")

          check_file_age("macd_state.sqlite", "MACD Bot", threshold_hours=2)
          check_file_age("fib_state.sqlite", "Fibonacci Pivot Bot", threshold_hours=2)

          print("✅ Watchdog check complete.")
          PYCODE
